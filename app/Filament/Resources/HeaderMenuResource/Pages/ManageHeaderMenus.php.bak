<?php

namespace App\Filament\Resources\HeaderMenuResource\Pages;

use App\Filament\Resources\HeaderMenuResource;
use Filament\Resources\Pages\Page;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Forms\Contracts\HasForms;
use Filament\Notifications\Notification;
use Filament\Actions\Action;
use Illuminate\Contracts\View\View;
use Filament\Forms\Form;
use Filament\Forms\Components\Section;
use Filament\Forms\Components\Repeater;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Toggle;
use Filament\Forms\Components\Grid;
use Filament\Forms\Components\Placeholder;
use Filament\Forms\Components\Actions;
use Illuminate\Support\Str;

class ManageHeaderMenus extends Page implements HasForms
{
    use InteractsWithForms;

    protected static string $resource = HeaderMenuResource::class;

    protected static string $view = 'filament.resources.header-menu-resource.pages.manage-header-menus';
    
    protected static ?string $title = 'í—¤ë” ë©”ë‰´ í¸ì§‘';
    
    public ?array $data = [];
    
    public function mount(): void
    {
        // project_optionsì—ì„œ í—¤ë” ë©”ë‰´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        $headerMenu = get_option('header_menu', []);
        
        $this->form->fill([
            'menu_items' => $headerMenu
        ]);
    }
    
    public function form(Form $form): Form
    {
        return $form
            ->schema([
                // ì•ˆë‚´ ë©”ì‹œì§€
                Section::make()
                    ->schema([
                        Placeholder::make('guide')
                            ->label('')
                            ->content('ğŸ” ë©”ë‰´ë¥¼ ì¶”ê°€í•˜ê³  ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ìœ„ ë©”ë‰´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ê°€ ë©ë‹ˆë‹¤.')
                    ]),
                    
                Section::make('í—¤ë” ë©”ë‰´ ì„¤ì •')
                    ->description('ì›¹ì‚¬ì´íŠ¸ ìƒë‹¨ì— í‘œì‹œë˜ëŠ” ë©”ë‰´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.')
                    ->schema([
                        Repeater::make('menu_items')
                            ->label('ë©”ë‰´ ëª©ë¡')
                            ->schema([
                                Grid::make(3)
                                    ->schema([
                                        TextInput::make('label')
                                            ->label('ğŸ“ ë©”ë‰´ ì´ë¦„')
                                            ->required()
                                            ->placeholder('ì˜ˆ: íšŒì‚¬ì†Œê°œ')
                                            ->helperText('ë©”ë‰´ì— í‘œì‹œë  ì´ë¦„')
                                            ->extraAttributes([
                                                'style' => 'font-size: 1.1rem;'
                                            ]),
                                        
                                        TextInput::make('url')
                                            ->label('ğŸ”— ë§í¬ ì£¼ì†Œ')
                                            ->placeholder('/about')
                                            ->helperText('í•˜ìœ„ ë©”ë‰´ê°€ ìˆìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”')
                                            ->reactive()
                                            ->extraAttributes([
                                                'style' => 'font-size: 1.1rem;'
                                            ]),
                                            
                                        Toggle::make('active')
                                            ->label('í™œì„±í™”')
                                            ->default(true)
                                            ->inline()
                                            ->helperText('ë©”ë‰´ í‘œì‹œ ì—¬ë¶€'),
                                    ]),
                                
                                // í•˜ìœ„ ë©”ë‰´ (ë‹¨ìˆœí™”)
                                Repeater::make('children')
                                    ->label('ğŸ“‚ í•˜ìœ„ ë©”ë‰´')
                                    ->schema([
                                        Grid::make(2)
                                            ->schema([
                                                TextInput::make('label')
                                                    ->label('í•˜ìœ„ ë©”ë‰´ ì´ë¦„')
                                                    ->required()
                                                    ->placeholder('ì˜ˆ: CEO ì¸ì‚¬ë§')
                                                    ->extraAttributes([
                                                        'style' => 'font-size: 1.05rem;'
                                                    ]),
                                                
                                                TextInput::make('url')
                                                    ->label('ë§í¬ ì£¼ì†Œ')
                                                    ->required()
                                                    ->placeholder('/about/ceo')
                                                    ->extraAttributes([
                                                        'style' => 'font-size: 1.05rem;'
                                                    ]),
                                            ]),
                                    ])
                                    ->collapsed()
                                    ->itemLabel(fn (array $state): ?string => 'â””â”€ ' . ($state['label'] ?? 'í•˜ìœ„ ë©”ë‰´'))
                                    ->addActionLabel('â• í•˜ìœ„ ë©”ë‰´ ì¶”ê°€')
                                    ->reorderable()
                                    ->collapsible()
                                    ->helperText('í•˜ìœ„ ë©”ë‰´ë¥¼ ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ê°€ ë©ë‹ˆë‹¤'),
                            ])
                            ->collapsed()
                            ->itemLabel(function (array $state): ?string {
                                $label = $state['label'] ?? 'ìƒˆ ë©”ë‰´';
                                $childCount = count($state['children'] ?? []);
                                if (!($state['active'] ?? true)) {
                                    $label = "ğŸ”´ {$label}";
                                }
                                return $childCount > 0 
                                    ? "ğŸ“ {$label} ({$childCount}ê°œ í•˜ìœ„ë©”ë‰´)" 
                                    : "ğŸ“„ {$label}";
                            })
                            ->addActionLabel('â• ë©”ì¸ ë©”ë‰´ ì¶”ê°€')
                            ->reorderable()
                            ->maxItems(10)
                            ->defaultItems(0)
                            ->collapsible()
                            ->extraAttributes([
                                'class' => 'menu-repeater'
                            ]),
                    ]),
                    
                // ìì£¼ ì‚¬ìš©í•˜ëŠ” ë©”ë‰´ í…œí”Œë¦¿
                Section::make('ë¹ ë¥¸ í…œí”Œë¦¿')
                    ->description('ìì£¼ ì‚¬ìš©í•˜ëŠ” ë©”ë‰´ êµ¬ì¡°ë¥¼ ë¹ ë¥´ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤')
                    ->collapsed()
                    ->schema([
                        Actions::make([
                            Actions\Action::make('add_company_menu')
                                ->label('ğŸ¢ íšŒì‚¬ì†Œê°œ ë©”ë‰´ ì¶”ê°€')
                                ->action(function ($livewire) {
                                    $currentData = $livewire->data['menu_items'] ?? [];
                                    $companyMenu = [
                                        'label' => 'íšŒì‚¬ì†Œê°œ',
                                        'url' => '',
                                        'active' => true,
                                        'children' => [
                                            ['label' => 'CEO ì¸ì‚¬ë§', 'url' => '/about/ceo'],
                                            ['label' => 'íšŒì‚¬ ì—°í˜', 'url' => '/about/history'],
                                            ['label' => 'ì¡°ì§ë„', 'url' => '/about/organization'],
                                            ['label' => 'ì˜¤ì‹œëŠ” ê¸¸', 'url' => '/about/location'],
                                        ]
                                    ];
                                    $currentData[] = $companyMenu;
                                    $livewire->data['menu_items'] = $currentData;
                                    
                                    Notification::make()
                                        ->title('íšŒì‚¬ì†Œê°œ ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤')
                                        ->success()
                                        ->send();
                                })
                                ->color('gray')
                                ->size('lg'),
                                
                            Actions\Action::make('add_service_menu')
                                ->label('ğŸ’¼ ì„œë¹„ìŠ¤ ë©”ë‰´ ì¶”ê°€')
                                ->action(function ($livewire) {
                                    $currentData = $livewire->data['menu_items'] ?? [];
                                    $serviceMenu = [
                                        'label' => 'ì„œë¹„ìŠ¤',
                                        'url' => '',
                                        'active' => true,
                                        'children' => [
                                            ['label' => 'ì„œë¹„ìŠ¤ ì†Œê°œ', 'url' => '/service/intro'],
                                            ['label' => 'ì´ìš© ì•ˆë‚´', 'url' => '/service/guide'],
                                            ['label' => 'ìš”ê¸ˆ ì•ˆë‚´', 'url' => '/service/pricing'],
                                        ]
                                    ];
                                    $currentData[] = $serviceMenu;
                                    $livewire->data['menu_items'] = $currentData;
                                    
                                    Notification::make()
                                        ->title('ì„œë¹„ìŠ¤ ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤')
                                        ->success()
                                        ->send();
                                })
                                ->color('gray')
                                ->size('lg'),
                                
                            Actions\Action::make('add_support_menu')
                                ->label('ğŸ“ ê³ ê°ì§€ì› ë©”ë‰´ ì¶”ê°€')
                                ->action(function ($livewire) {
                                    $currentData = $livewire->data['menu_items'] ?? [];
                                    $supportMenu = [
                                        'label' => 'ê³ ê°ì§€ì›',
                                        'url' => '',
                                        'active' => true,
                                        'children' => [
                                            ['label' => 'ê³µì§€ì‚¬í•­', 'url' => '/support/notice'],
                                            ['label' => 'FAQ', 'url' => '/support/faq'],
                                            ['label' => '1:1 ë¬¸ì˜', 'url' => '/support/contact'],
                                            ['label' => 'ìë£Œì‹¤', 'url' => '/support/downloads'],
                                        ]
                                    ];
                                    $currentData[] = $supportMenu;
                                    $livewire->data['menu_items'] = $currentData;
                                    
                                    Notification::make()
                                        ->title('ê³ ê°ì§€ì› ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤')
                                        ->success()
                                        ->send();
                                })
                                ->color('gray')
                                ->size('lg'),
                        ])->columns(3),
                    ]),
            ])
            ->statePath('data');
    }
    
    public function save(): void
    {
        $data = $this->form->getState();
        
        // project_optionsì— ì €ì¥
        update_option('header_menu', $data['menu_items'] ?? []);
        
        // ì„±ê³µ ë©”ì‹œì§€
        Notification::make()
            ->title('âœ… ë©”ë‰´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')
            ->body('ë³€ê²½ì‚¬í•­ì´ ì›¹ì‚¬ì´íŠ¸ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.')
            ->success()
            ->duration(5000)
            ->send();
            
        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ë°ì´í„° í‘œì‹œ
        $this->redirect(static::getUrl());
    }
    
    protected function getHeaderActions(): array
    {
        return [
            Action::make('custom')
                ->label('ğŸ¨ ì‹œê°ì  í¸ì§‘ê¸°')
                ->url(fn () => static::getResource()::getUrl('custom'))
                ->color('success')
                ->icon('heroicon-o-paint-brush')
                ->size('lg'),
                
            Action::make('preview')
                ->label('ğŸ‘ ë¯¸ë¦¬ë³´ê¸°')
                ->action(fn () => $this->dispatch('open-preview-modal'))
                ->color('gray')
                ->icon('heroicon-o-eye')
                ->size('lg'),
                
            Action::make('save')
                ->label('ğŸ’¾ ë©”ë‰´ ì €ì¥')
                ->action('save')
                ->color('primary')
                ->icon('heroicon-o-check')
                ->size('lg')
                ->extraAttributes([
                    'class' => 'text-lg'
                ]),
        ];
    }
    
    public function getTitle(): string
    {
        return 'í—¤ë” ë©”ë‰´ í¸ì§‘';
    }
    
    public function getHeading(): string
    {
        return 'ğŸ”§ í—¤ë” ë©”ë‰´ ê´€ë¦¬';
    }
    
    public function getSubheading(): ?string
    {
        return 'ì›¹ì‚¬ì´íŠ¸ ìƒë‹¨ ë©”ë‰´ë¥¼ ì‰½ê²Œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì€ ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.';
    }
    
    // ë¯¸ë¦¬ë³´ê¸°ìš© ë©”ë‰´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    public function getPreviewData(): array
    {
        return $this->data['menu_items'] ?? [];
    }
}