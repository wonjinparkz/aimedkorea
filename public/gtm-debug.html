<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Debug - Preview Connection Fix</title>
    
    <!-- Google Tag Manager - í”„ë¡œë•ì…˜ í™˜ê²½ ê°•ì œ ì ìš© -->
    <script>
        // GTM Preview ëª¨ë“œë¥¼ ìœ„í•œ ì¿ í‚¤ ë° íŒŒë¼ë¯¸í„° ì²´í¬
        console.log('ğŸ” GTM Debug Mode Active');
        
        // DataLayer ì´ˆê¸°í™” (GTM ë¡œë“œ ì „ì— ì‹¤í–‰)
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'event': 'gtm.init',
            'gtm.start': new Date().getTime()
        });
    </script>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N8GJF2QW');</script>
    <!-- End Google Tag Manager -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .status-card {
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .status-card.success {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .status-card.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .status-card.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .status-card h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            background: #007bff;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #333;
        }
        
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .console-line {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .console-line.info {
            border-color: #007bff;
        }
        
        .console-line.success {
            border-color: #28a745;
            color: #72d572;
        }
        
        .console-line.error {
            border-color: #dc3545;
            color: #ff6b6b;
        }
        
        .console-line.warning {
            border-color: #ffc107;
            color: #ffd93d;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 10px 0;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            color: #d63384;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N8GJF2QW"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div class="container">
        <h1>ğŸ”§ GTM Preview Connection Debugger</h1>
        <p class="subtitle">GTM-N8GJF2QW ì»¨í…Œì´ë„ˆ ì—°ê²° ë¬¸ì œ í•´ê²°</p>
        
        <div class="status-grid">
            <div class="status-card" id="status-gtm">
                <div class="icon">ğŸ“¦</div>
                <h3>GTM ìŠ¤í¬ë¦½íŠ¸</h3>
                <p>í™•ì¸ ì¤‘...</p>
            </div>
            
            <div class="status-card" id="status-container">
                <div class="icon">ğŸ·ï¸</div>
                <h3>ì»¨í…Œì´ë„ˆ ID</h3>
                <p>GTM-N8GJF2QW</p>
            </div>
            
            <div class="status-card" id="status-datalayer">
                <div class="icon">ğŸ“Š</div>
                <h3>DataLayer</h3>
                <p>í™•ì¸ ì¤‘...</p>
            </div>
            
            <div class="status-card" id="status-preview">
                <div class="icon">ğŸ‘ï¸</div>
                <h3>Preview Mode</h3>
                <p>í™•ì¸ ì¤‘...</p>
            </div>
            
            <div class="status-card" id="status-cookies">
                <div class="icon">ğŸª</div>
                <h3>ì¿ í‚¤ ìƒíƒœ</h3>
                <p>í™•ì¸ ì¤‘...</p>
            </div>
            
            <div class="status-card" id="status-network">
                <div class="icon">ğŸŒ</div>
                <h3>ë„¤íŠ¸ì›Œí¬</h3>
                <p>í™•ì¸ ì¤‘...</p>
            </div>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“‹ GTM Preview ì—°ê²° ë°©ë²•</h3>
            <ol>
                <li><strong>ì´ í˜ì´ì§€ë¥¼ ë¨¼ì € ì—´ì–´ë‘ì„¸ìš”</strong> (https://ai-med.co.kr/gtm-debug.html)</li>
                <li>GTM ê´€ë¦¬ í™”ë©´ì—ì„œ <strong>"ë¯¸ë¦¬ë³´ê¸°"</strong> ë²„íŠ¼ í´ë¦­</li>
                <li>ì—°ê²°í•  URLì— <code>https://ai-med.co.kr/gtm-debug.html</code> ì…ë ¥</li>
                <li>ìƒˆ íƒ­ì´ ì—´ë¦¬ë©´ <strong>"ì—°ê²°"</strong> ë²„íŠ¼ í´ë¦­</li>
                <li>ì•„ë˜ <strong>"Preview ëª¨ë“œ í™œì„±í™”"</strong> ë²„íŠ¼ì„ í´ë¦­</li>
            </ol>
        </div>
        
        <div class="button-group">
            <button class="btn" onclick="checkAllSystems()">ğŸ” ì „ì²´ ì‹œìŠ¤í…œ ì ê²€</button>
            <button class="btn success" onclick="activatePreviewMode()">ğŸ‘ï¸ Preview ëª¨ë“œ í™œì„±í™”</button>
            <button class="btn warning" onclick="clearGTMCache()">ğŸ—‘ï¸ GTM ìºì‹œ ì •ë¦¬</button>
            <button class="btn" onclick="sendTestEvent()">ğŸ“¤ í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë°œì†¡</button>
            <button class="btn" onclick="window.location.reload()">ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <h2>ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <div class="console" id="console">
            <div class="console-line info">ğŸš€ GTM Debug Console ì‹œì‘...</div>
        </div>
        
        <h2>ğŸ”§ ë¬¸ì œ í•´ê²°</h2>
        <div class="button-group">
            <button class="btn" onclick="fixSSLIssue()">ğŸ”’ SSL/HTTPS ë¬¸ì œ í•´ê²°</button>
            <button class="btn" onclick="fixCORSIssue()">ğŸŒ CORS ë¬¸ì œ í•´ê²°</button>
            <button class="btn" onclick="fixTimeoutIssue()">â±ï¸ íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°</button>
            <button class="btn" onclick="showDetailedInfo()">ğŸ“‹ ìƒì„¸ ì •ë³´ ë³´ê¸°</button>
        </div>
    </div>
    
    <script>
        // ì½˜ì†” ë¡œê¹… í•¨ìˆ˜
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.innerHTML = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
            
            // ì‹¤ì œ ì½˜ì†”ì—ë„ ì¶œë ¥
            window.console.log(`[GTM Debug] ${message}`);
        }
        
        // ì‹œìŠ¤í…œ ì²´í¬
        function checkAllSystems() {
            log('ğŸ” ì „ì²´ ì‹œìŠ¤í…œ ì ê²€ ì‹œì‘...', 'info');
            
            // GTM ìŠ¤í¬ë¦½íŠ¸ ì²´í¬
            const gtmLoaded = typeof google_tag_manager !== 'undefined';
            const statusGtm = document.getElementById('status-gtm');
            if (gtmLoaded) {
                statusGtm.className = 'status-card success';
                statusGtm.querySelector('p').textContent = 'âœ… ë¡œë“œë¨';
                log('âœ… GTM ìŠ¤í¬ë¦½íŠ¸ ì •ìƒ ë¡œë“œ', 'success');
            } else {
                statusGtm.className = 'status-card error';
                statusGtm.querySelector('p').textContent = 'âŒ ë¡œë“œ ì‹¤íŒ¨';
                log('âŒ GTM ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
            
            // ì»¨í…Œì´ë„ˆ ì²´í¬
            const containerExists = gtmLoaded && google_tag_manager['GTM-N8GJF2QW'];
            const statusContainer = document.getElementById('status-container');
            if (containerExists) {
                statusContainer.className = 'status-card success';
                log('âœ… GTM-N8GJF2QW ì»¨í…Œì´ë„ˆ í™œì„±', 'success');
            } else {
                statusContainer.className = 'status-card warning';
                log('âš ï¸ GTM-N8GJF2QW ì»¨í…Œì´ë„ˆ í™•ì¸ í•„ìš”', 'warning');
            }
            
            // DataLayer ì²´í¬
            const dataLayerExists = window.dataLayer && Array.isArray(window.dataLayer);
            const statusDataLayer = document.getElementById('status-datalayer');
            if (dataLayerExists) {
                statusDataLayer.className = 'status-card success';
                statusDataLayer.querySelector('p').textContent = `âœ… ${window.dataLayer.length}ê°œ ì´ë²¤íŠ¸`;
                log(`âœ… DataLayer í™œì„± (${window.dataLayer.length}ê°œ ì´ë²¤íŠ¸)`, 'success');
            } else {
                statusDataLayer.className = 'status-card error';
                statusDataLayer.querySelector('p').textContent = 'âŒ ì´ˆê¸°í™” ì‹¤íŒ¨';
                log('âŒ DataLayer ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            }
            
            // Preview ëª¨ë“œ ì²´í¬
            const previewCookie = document.cookie.includes('gtm_preview');
            const previewParam = window.location.search.includes('gtm_preview');
            const statusPreview = document.getElementById('status-preview');
            if (previewCookie || previewParam) {
                statusPreview.className = 'status-card success';
                statusPreview.querySelector('p').textContent = 'âœ… í™œì„±';
                log('âœ… Preview ëª¨ë“œ í™œì„±', 'success');
            } else {
                statusPreview.className = 'status-card warning';
                statusPreview.querySelector('p').textContent = 'âš ï¸ ë¹„í™œì„±';
                log('âš ï¸ Preview ëª¨ë“œ ë¹„í™œì„±', 'warning');
            }
            
            // ì¿ í‚¤ ì²´í¬
            const cookiesEnabled = navigator.cookieEnabled;
            const statusCookies = document.getElementById('status-cookies');
            if (cookiesEnabled) {
                statusCookies.className = 'status-card success';
                statusCookies.querySelector('p').textContent = 'âœ… í™œì„±';
                log('âœ… ì¿ í‚¤ í™œì„±í™”ë¨', 'success');
            } else {
                statusCookies.className = 'status-card error';
                statusCookies.querySelector('p').textContent = 'âŒ ë¹„í™œì„±';
                log('âŒ ì¿ í‚¤ ë¹„í™œì„±í™”ë¨', 'error');
            }
            
            // ë„¤íŠ¸ì›Œí¬ ì²´í¬
            const isHTTPS = window.location.protocol === 'https:';
            const statusNetwork = document.getElementById('status-network');
            if (isHTTPS) {
                statusNetwork.className = 'status-card success';
                statusNetwork.querySelector('p').textContent = 'âœ… HTTPS';
                log('âœ… HTTPS ì—°ê²°', 'success');
            } else {
                statusNetwork.className = 'status-card warning';
                statusNetwork.querySelector('p').textContent = 'âš ï¸ HTTP';
                log('âš ï¸ HTTP ì—°ê²° (HTTPS ê¶Œì¥)', 'warning');
            }
            
            log('ğŸ ì‹œìŠ¤í…œ ì ê²€ ì™„ë£Œ', 'info');
        }
        
        // Preview ëª¨ë“œ í™œì„±í™”
        function activatePreviewMode() {
            log('ğŸ‘ï¸ Preview ëª¨ë“œ í™œì„±í™” ì‹œë„...', 'info');
            
            // GTM Preview ì¿ í‚¤ ì„¤ì •
            document.cookie = 'gtm_preview=true; path=/; secure; samesite=none';
            document.cookie = 'gtm_debug=x; path=/; secure; samesite=none';
            
            // DataLayerì— ë””ë²„ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'gtm.dom',
                'gtm.debug': true,
                'gtm.preview': 'GTM-N8GJF2QW'
            });
            
            log('âœ… Preview ëª¨ë“œ ì¿ í‚¤ ì„¤ì • ì™„ë£Œ', 'success');
            log('âœ… ë””ë²„ê·¸ ì´ë²¤íŠ¸ ë°œì†¡ ì™„ë£Œ', 'success');
            
            // URL íŒŒë¼ë¯¸í„° ì¶”ê°€
            if (!window.location.search.includes('gtm_preview')) {
                const newUrl = window.location.href + (window.location.search ? '&' : '?') + 
                              'gtm_preview=GTM-N8GJF2QW&gtm_cookies_win=x';
                log(`ğŸ”„ URL íŒŒë¼ë¯¸í„° ì¶”ê°€: ${newUrl}`, 'info');
                
                setTimeout(() => {
                    window.location.href = newUrl;
                }, 1000);
            }
        }
        
        // GTM ìºì‹œ ì •ë¦¬
        function clearGTMCache() {
            log('ğŸ—‘ï¸ GTM ìºì‹œ ì •ë¦¬ ì‹œì‘...', 'info');
            
            // ì¿ í‚¤ ì •ë¦¬
            document.cookie.split(";").forEach(function(c) { 
                if(c.includes('gtm') || c.includes('_ga')) {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + 
                                     new Date().toUTCString() + ";path=/");
                }
            });
            
            // SessionStorage ì •ë¦¬
            Object.keys(sessionStorage).forEach(key => {
                if(key.includes('gtm') || key.includes('ga')) {
                    sessionStorage.removeItem(key);
                }
            });
            
            // LocalStorage ì •ë¦¬
            Object.keys(localStorage).forEach(key => {
                if(key.includes('gtm') || key.includes('ga')) {
                    localStorage.removeItem(key);
                }
            });
            
            log('âœ… ìºì‹œ ì •ë¦¬ ì™„ë£Œ', 'success');
            log('ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”', 'warning');
        }
        
        // í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë°œì†¡
        function sendTestEvent() {
            log('ğŸ“¤ í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë°œì†¡...', 'info');
            
            const testEvent = {
                'event': 'gtm_debug_test',
                'test_id': Date.now(),
                'test_type': 'debug_connection',
                'container_id': 'GTM-N8GJF2QW',
                'timestamp': new Date().toISOString(),
                'url': window.location.href,
                'user_agent': navigator.userAgent
            };
            
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push(testEvent);
            
            log('âœ… í…ŒìŠ¤íŠ¸ ì´ë²¤íŠ¸ ë°œì†¡ ì™„ë£Œ: ' + JSON.stringify(testEvent), 'success');
        }
        
        // SSL ë¬¸ì œ í•´ê²°
        function fixSSLIssue() {
            log('ğŸ”’ SSL/HTTPS ë¬¸ì œ í™•ì¸...', 'info');
            
            if (window.location.protocol !== 'https:') {
                log('âš ï¸ HTTPë¡œ ì ‘ì† ì¤‘. HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤...', 'warning');
                window.location.protocol = 'https:';
            } else {
                log('âœ… HTTPS ì—°ê²° í™•ì¸ë¨', 'success');
            }
        }
        
        // CORS ë¬¸ì œ í•´ê²°
        function fixCORSIssue() {
            log('ğŸŒ CORS ì„¤ì • í™•ì¸...', 'info');
            
            // Test GTM endpoint
            fetch('https://www.googletagmanager.com/gtm.js?id=GTM-N8GJF2QW', {
                mode: 'no-cors'
            }).then(() => {
                log('âœ… GTM ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥', 'success');
            }).catch(error => {
                log('âŒ GTM ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨: ' + error.message, 'error');
            });
        }
        
        // íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°
        function fixTimeoutIssue() {
            log('â±ï¸ ì—°ê²° íƒ€ì„ì•„ì›ƒ í…ŒìŠ¤íŠ¸...', 'info');
            
            const startTime = Date.now();
            const img = new Image();
            img.src = 'https://www.googletagmanager.com/gtm.js?id=GTM-N8GJF2QW&t=' + Date.now();
            
            img.onload = function() {
                const loadTime = Date.now() - startTime;
                log(`âœ… GTM ì‘ë‹µ ì‹œê°„: ${loadTime}ms`, 'success');
            };
            
            img.onerror = function() {
                log('âŒ GTM ì„œë²„ ì‘ë‹µ ì—†ìŒ', 'error');
            };
            
            setTimeout(() => {
                if (Date.now() - startTime > 5000) {
                    log('âš ï¸ ì—°ê²° íƒ€ì„ì•„ì›ƒ (5ì´ˆ ì´ˆê³¼)', 'warning');
                }
            }, 5000);
        }
        
        // ìƒì„¸ ì •ë³´ í‘œì‹œ
        function showDetailedInfo() {
            log('ğŸ“‹ ìƒì„¸ ì •ë³´ ìˆ˜ì§‘...', 'info');
            
            const info = {
                'Browser': navigator.userAgent,
                'Cookies Enabled': navigator.cookieEnabled,
                'Online Status': navigator.onLine,
                'Protocol': window.location.protocol,
                'Host': window.location.host,
                'Pathname': window.location.pathname,
                'GTM Status': typeof google_tag_manager !== 'undefined' ? 'Loaded' : 'Not Loaded',
                'DataLayer Length': window.dataLayer ? window.dataLayer.length : 0,
                'Preview Cookie': document.cookie.includes('gtm_preview'),
                'Debug Cookie': document.cookie.includes('gtm_debug'),
                'Container Active': typeof google_tag_manager !== 'undefined' && 
                                  google_tag_manager['GTM-N8GJF2QW'] ? 'Yes' : 'No'
            };
            
            for (let key in info) {
                log(`${key}: ${info[key]}`, 'info');
            }
        }
        
        // DataLayer ëª¨ë‹ˆí„°ë§
        function monitorDataLayer() {
            if (window.dataLayer && window.dataLayer.push) {
                const originalPush = window.dataLayer.push;
                window.dataLayer.push = function() {
                    const result = originalPush.apply(window.dataLayer, arguments);
                    if (arguments[0] && arguments[0].event) {
                        log(`ğŸ“Š DataLayer ì´ë²¤íŠ¸: ${arguments[0].event}`, 'success');
                    }
                    return result;
                };
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('load', function() {
            log('ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
            checkAllSystems();
            monitorDataLayer();
            
            // GTMì´ ëŠ¦ê²Œ ë¡œë“œë˜ëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ì¬í™•ì¸
            setTimeout(checkAllSystems, 2000);
        });
        
        // GTM ë¡œë“œ ì´ë²¤íŠ¸ ê°ì§€
        window.addEventListener('gtm.load', function() {
            log('ğŸ‰ GTM ë¡œë“œ ì´ë²¤íŠ¸ ê°ì§€!', 'success');
        });
    </script>
</body>
</html>